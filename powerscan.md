# MASSCAN and NMAP

Two very powerfull tools to scan hosts are masscan and nmap. 

There is alot to know to unleash the true power of these tools, these general commands will help in most cases.

This scanning technique only works for single hosts, very good in CTF like challenges.

## Masscan super scan

First, run a mass scan to all tcp and udp ports, redirect output to a file: 

    masscan -p1-65535,U:1-65535 target.local --rate=100000 -e eth0 --wait 5 > mascan-target.txt
    
Second, run an Nmap against the output of masscan:

    /home/user/scripts/parse_mscan.py; while read each; do sudo nmap -sV -O -sC -sS -sU $each; done < nmap.txt
    
OR...

## Use this super scanner


```
#!/bin/python

# Original script:
# https://raw.githubusercontent.com/Crypto-Cat/CTF/main/pentesting/gen_nmap.py

# This script execites Masscan and uses the result to feed an nmap scan.
# IMPORTANT: masscan uses a special stack, it does not work with localhost

# Files generated by this script: mscan.xml, nmap.txt, nmap.xml
# Next, query for vulnerable services

# Import regex, socket and os
import re, sys, subprocess
from socket import inet_aton
from os import path
target = sys.argv[1]

# MSCAN the target
print('[+] Executing masscan')
print('[+] Target: '+target)

masscan_cmd = [target,"-p1-65535,U:1-65535","--rate","50000","-e","eth0","--wait","5","--output-filename","mscan.xml"]
subprocess.run(["/usr/bin/masscan",masscan_cmd[0],masscan_cmd[1],masscan_cmd[2],masscan_cmd[3],masscan_cmd[4],masscan_cmd[5],masscan_cmd[6],masscan_cmd[7],masscan_cmd[8],masscan_cmd[9]])

print('[+] Done executing masscan')
print('[+] Creating mscan.xml')

# Extract port_num/proto from masscan output
#regex = re.compile(r"protocol="(\d)\/(udp|tcp)" portid="(\d+)"", re.I)
host_list = {}

with open(path.abspath('mscan.xml')) as f:
  lines = f.readlines()
  for line in lines:
    if line.startswith("<host "):
      host = target
      port = re.findall("[0-9]+", line)
      protocol = re.search(r"(udp|tcp)", line)
      print("[+] target :" + host+' '+port[6]+' '+protocol.group())
# Add the IP to dictionary if it's not already
      try:
        host_list[host]
      except KeyError:
        host_list[host] = {}
# Add protocol to dictionary if it's not already
      try:
        host_list[host][protocol.group()]
      except KeyError:
        host_list[host][protocol.group()] = []
# Append the port to the list
      host_list[host][protocol.group()].append(port[6])
print('[+] Parsing mscan.xml')
print('[+] Creating nmap.txt')
print('[+] Preparing nmap command')

with open(path.abspath('nmap.txt'), 'a') as f:
  sorted_ips = sorted(host_list.items(), key=lambda item: inet_aton(item[0]))
  for ip, protocols in sorted_ips:
    udp_ports = ""
    tcp_ports = ""
# Check to see if any UDP ports were found
  try:
    for port in protocols['udp']:
      udp_ports += port + ','
    udp_ports = udp_ports[:-1]
  except KeyError:
    pass
# Check to see if any TCP ports were found
  try:
    for port in protocols['tcp']:
      tcp_ports += port + ','
    tcp_ports = tcp_ports[:-1]
  except KeyError:
    pass
# Print IP and ports to file ready for NMap scan
  if udp_ports and tcp_ports:
    line = ip + ' -p U:' + udp_ports + ',T:' + tcp_ports
  elif udp_ports:
    line = ip + ' -p U:' + udp_ports
  elif tcp_ports:
    line = ip + ' -p T:' + tcp_ports
  f.write(line + '\n')

# Execute nmap

print('[+] Executing nmap')
with open(path.abspath('nmap.txt')) as f:
  lines = f.readlines()
  for line in lines:
    nmap_cmd = line.split(" ")
    nmap_cmd[2] = nmap_cmd[2][:-1]
    subprocess.run(["/usr/bin/nmap","-sV","-O","-sC","-sS","-sU",nmap_cmd[0],nmap_cmd[1],nmap_cmd[2],"-oX","nmap.xml"])

print('[+] Done.')
print('[+] Read mscan.xml nmap.txt and nmap.xml for reports.')
```

